<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="itemBoardMapper">

	<resultMap type="member" id="member_rm">
	
		<id property="memberNo" 			column="MEMBER_NO"/>
		<result property="memberId" 		column="MEMBER_ID"/>
		<result property="memberPw" 		column="MEMBER_PW"/>
		<result property="memberNickname" 	column="MEMBER_NICK"/>
		<result property="memberTel" 		column="MEMBER_TEL"/>
		<result property="secessionFlag" 	column="SECESSION_FL"/>
		<result property="memberProfile" 	column="MEMBER_PROFILE"/>
		<result property="memberGrape" 		column="MEMBER_GRAPE"/>
		<result property="memberAddress" 	column="MEMBER_ADDR"/>
		<result property="memberTown" 		column="MEMBER_TOWN"/>
		<result property="createDate" 		column="CREATE_DT"/>
		<result property="admin"  			column="ADMIN" />
		<result property="shopInfo"  			column="SHOP_INFO" />
	
	</resultMap>

	<resultMap type="boardType" id="boardType_rm">
		<id property="boardCode" column="BOARD_CD"/>
		
		<result property="boardName" column="BOARD_NM"/>
	</resultMap>

	<resultMap type="itemBoard" id="itemBoard_rm">

		<id property="boardNo" column="BOARD_NO" />

		<result property="boardTitle" column="BOARD_TITLE" />
		<result property="boardContent" column="BOARD_CONTENT" />
		<result property="readCount" column="READ_COUNT" />
		<result property="createDate" column="CREATE_DT" />
		<result property="updateDate" column="UPDATE_DT" />
		<result property="itemCondition" column="ITEM_CONDITION" />
		<result property="tradeCondition" column="TRADE_CONDITION" />

		<result property="delivery" column="DELIVERY" />

		<result property="price" column="PRICE" />
		<result property="secessionFlag" column="SECESSION_FL" />
		<result property="sellArea" column="SELL_AREA" />
		<result property="boardCode" column="BOARD_CD" />
		<result property="memberNo" column="MEMBER_NO" />
		<result property="categoryNo" column="M_CATEGORY_NO" />
		<result property="buyMemberNo" column="BUY_MEMBER_NO" />
		<result property="itemImage" column="ITEM_IMAGE" />
		<result property="bookmarkCount" column="BOOKMARK_COUNT" />

	</resultMap>
	
	<insert id="insertBoard" parameterType="itemBoard" useGeneratedKeys="true"> 
	
		<selectKey keyProperty="boardNo" resultType="_int" order="BEFORE">
			SELECT SEQ_BOARD_NO.NEXTVAL FROM DUAL
		</selectKey>
	
		INSERT INTO ITEM_BOARD VALUES(
			#{boardNo}, #{boardTitle}, #{boardContent},
			DEFAULT, DEFAULT, DEFAULT, #{itemCondition}, '판매 중', #{delivery}, #{price}, DEFAULT, '서울', 
			1, #{memberNo}, #{categoryNo}, NULL, NULL, 0 
		)
	</insert>
	
	<insert id="insertBoardImageList" parameterType="list" >
		
		INSERT INTO BOARD_IMG
			SELECT SEQ_IMG_NO.NEXTVAL IMG_NO, A.* FROM(
			
				<foreach collection="list" item="img" separator="UNION ALL" >
					SELECT 			#{img.imageReName} IMG_RENAME,
									#{img.imageOriginal} IMG_ORIGINAL,
									#{img.imageLevel} 			IMG_LEVEL,
									#{img.boardNo}		BOARD_NO
					FROM DUAL
				</foreach>
				
			) A
	
	</insert>
	
	<select id="selectItemList" resultMap="itemBoard_rm">
		SELECT BOARD_NO, BOARD_TITLE, ITEM_IMAGE, PRICE, UPDATE_DT, MEMBER_NO
		FROM ITEM_BOARD
		WHERE UPDATE_DT >= SYSDATE - 7
		ORDER BY READ_COUNT
	</select>


	<!-- 상품명 검색 -->
	<select id="searchBoard" resultMap="itemBoard_rm">
		SELECT BOARD_NO, BOARD_TITLE, ITEM_IMAGE, PRICE, UPDATE_DT, MEMBER_NO

		FROM ITEM_BOARD
		WHERE SECESSION_FL = 'N'

		<if test='query != null and query != ""'>
		
			AND
			( BOARD_TITLE LIKE '%${query}%'
			OR
			BOARD_CONTENT LIKE '%${query}%')

		</if>

		ORDER BY BOARD_NO DESC

	</select>
	
	
	<!-- 판매글 상세조회 -->
	<select id="selectItem" resultMap="itemBoard_rm">
		SELECT BOARD_TITLE, BOARD_CONTENT, READ_COUNT, BOOKMARK_COUNT, UPDATE_DT, SELL_AREA, ITEM_CONDITION, TRADE_CONDITION
			, PRICE
		FROM ITEM_BOARD
		WHERE BOARD_NO = ${boardNo}
	</select>
	
	<!-- 판매글에 해당하는 회원번호 조회 -->
	<select id="selectMemberNo" resultType="_int">
		SELECT MEMBER_NO
		FROM ITEM_BOARD
		WHERE BOARD_NO = ${boardNo}
	</select>
	
	<!-- 판매자 다른 상품 보기 -->
	<select id="selectOtherItems" resultMap="itemBoard_rm">
		SELECT * FROM (
			SELECT BOARD_TITLE, PRICE, UPDATE_DT, BOARD_NO
			FROM ITEM_BOARD
			WHERE MEMBER_NO = ${memberNo}
			AND BOARD_NO != ${boardNo}
			ORDER BY READ_COUNT DESC)
		<![CDATA[WHERE ROWNUM <= 5]]>
	</select>
	
	<!-- 판매자 회원 정보 조회 -->
	<select id="sellMemberInfo" resultMap="member_rm">
		SELECT MEMBER_NICK, MEMBER_GRAPE, MEMBER_PROFILE
		FROM MEMBER
		WHERE MEMBER_NO = ${memberNo}
	</select>
	
	<insert id="addFav">
		INSERT INTO BOOKMARK VALUES(${loginMemberNo}, ${boardNo})
	</insert>
	
	<insert id="addCountAdd">
		UPDATE ITEM_BOARD SET BOOKMARK_COUNT = BOOKMARK_COUNT + 1
		WHERE BOARD_NO = ${boardNo}
	</insert>


</mapper>


